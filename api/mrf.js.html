<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mrf.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Conference.html">Conference</a><ul class='methods'><li data-type='method'><a href="Conference.html#agc">agc</a></li><li data-type='method'><a href="Conference.html#chkRecord">chkRecord</a></li><li data-type='method'><a href="Conference.html#deafAll">deafAll</a></li><li data-type='method'><a href="Conference.html#destroy">destroy</a></li><li data-type='method'><a href="Conference.html#lock">lock</a></li><li data-type='method'><a href="Conference.html#muteAll">muteAll</a></li><li data-type='method'><a href="Conference.html#pauseRecording">pauseRecording</a></li><li data-type='method'><a href="Conference.html#play">play</a></li><li data-type='method'><a href="Conference.html#resumeRecording">resumeRecording</a></li><li data-type='method'><a href="Conference.html#startRecording">startRecording</a></li><li data-type='method'><a href="Conference.html#stopRecording">stopRecording</a></li><li data-type='method'><a href="Conference.html#unlock">unlock</a></li></ul></li><li><a href="ConferenceConnection.html">ConferenceConnection</a><ul class='methods'><li data-type='method'><a href="ConferenceConnection.html#deaf">deaf</a></li><li data-type='method'><a href="ConferenceConnection.html#kick">kick</a></li><li data-type='method'><a href="ConferenceConnection.html#mute">mute</a></li><li data-type='method'><a href="ConferenceConnection.html#play">play</a></li><li data-type='method'><a href="ConferenceConnection.html#transfer">transfer</a></li></ul></li><li><a href="Endpoint.html">Endpoint</a><ul class='methods'><li data-type='method'><a href="Endpoint.html#api">api</a></li><li data-type='method'><a href="Endpoint.html#connected">connected</a></li><li data-type='method'><a href="Endpoint.html#destroy">destroy</a></li><li data-type='method'><a href="Endpoint.html#execute">execute</a></li><li data-type='method'><a href="Endpoint.html#joinConference">joinConference</a></li><li data-type='method'><a href="Endpoint.html#modifySession">modifySession</a></li><li data-type='method'><a href="Endpoint.html#play">play</a></li><li data-type='method'><a href="Endpoint.html#playCollect">playCollect</a></li><li data-type='method'><a href="Endpoint.html#say">say</a></li></ul></li><li><a href="MediaServer.html">MediaServer</a><ul class='methods'><li data-type='method'><a href="MediaServer.html#api">api</a></li><li data-type='method'><a href="MediaServer.html#connectCaller">connectCaller</a></li><li data-type='method'><a href="MediaServer.html#connected">connected</a></li><li data-type='method'><a href="MediaServer.html#createConference">createConference</a></li><li data-type='method'><a href="MediaServer.html#createEndpoint">createEndpoint</a></li><li data-type='method'><a href="MediaServer.html#disconnect">disconnect</a></li></ul></li><li><a href="Mrf.html">Mrf</a><ul class='methods'><li data-type='method'><a href="Mrf.html#connect">connect</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Endpoint.html#event:destroy">destroy</a></li><li><a href="MediaServer.html#event:connect">connect</a></li><li><a href="MediaServer.html#event:error">error</a></li><li><a href="MediaServer.html#event:ready">ready</a></li><li><a href="Mrf.html#event:error">error</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">mrf.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var esl = require('modesl') ;
var assert = require('assert') ;
var MediaServer = require('./mediaserver') ;
var Emitter = require('events').EventEmitter ;
var util = require('util') ;
var Srf = require('drachtio-srf');
var noop = require('node-noop').noop;
var debug = require('debug')('drachtio-fsmrf') ;

/**
 * Creates a media resource framework instance.
 * @constructor
 * @param {Object} app - drachtio app
 * @param {Mrf~createOptions} [opts] configuration options
 */
function Mrf( app, opts ) {
  if (!(this instanceof Mrf)) { return new Mrf(app); }

  opts = opts || {} ;
  assert.equal( typeof app, 'function', 'argument \'app\' was not provided or was not a drachtio app') ;
  assert.ok( typeof opts.debugDir === 'undefined' || typeof opts.debugDir === 'string', '\'opts.debugDir\' must be a function') ;

  var host = app.get('host') ;
  var port = app.get('port') ;
  var secret = app.get('secret') ;
  debug('host: %s, port: %s, secret: %s', host, port, secret) ;

  //TODO: caller should optionally be able to pass in connect args and we create our own app

  Emitter.call(this); 

  opts = opts || {} ;
  this._app = app ;
  this.debugDir = opts.debugDir ;
  this.mediaServers = [] ;


  this._srf = new Srf(app) ;

  Object.defineProperty( this, 'srf', {
    get: function() {
      return this._srf ;
    }
  }) ;
}
/**
 * Options governing the creation of an mrf instance
 * @typedef {Object} Mrf~createOptions
 * @property {string} [debugDir] directory into which message trace files; the presence of this param will enable debug tracing
 * 
 */

util.inherits(Mrf, Emitter) ;


module.exports = exports = Mrf ;


/**
 * connect to the event socket of a freeswitch media server
 * 
 * @param  {Mrf~ConnectOptions}   opts - connection options
 * @param  {Mrf~ConnectCallback} cb - callback invoked after connection is made
 * @fires Mrf#error
 */
Mrf.prototype.connect = function( opts, cb ) {
  assert.equal( typeof opts, 'object', 'argument \'opts\' must be provided with connection options') ;
  assert.equal( typeof opts.address,'string', 'argument \'opts.address\' was not provided') ;

  var self = this ;
  var address = opts.address ;
  var port = opts.port || 8021 ;
  var secret = opts.secret || 'ClueCon' ;
  var listenPort = opts.listenPort || 8085 ;
  cb = cb || noop ;

  //handle connection errors in the MRF...
  var listener = this._onError.bind(this)  ;

  debug('connecting');
  var conn = new esl.Connection(address, port, secret, function() {

    //...until we have initially connected and created a MediaServer object (which takes over error reporting)
    conn.removeListener('error', listener) ;

    var ms = new MediaServer( conn, self, self._app, listenPort ) ;
    self.mediaServers.push( ms ) ;

    ms.once('ready', function() {
      cb( ms ) ;
      self.emit('connect', ms) ;
    }) ;
  });

  conn.on('error', listener);

} ;
/**
 * This callback provides the response to a connection attempt to a freeswitch server
 * @callback Mrf~ConnectCallback
 * @param {MediaServer} ms - MediaServer instance
 */

Mrf.prototype._onError = function(err) {
    this.emit('error', err);
};

/**
 * Arguments provided when connecting to a freeswitch media server
 * @typedef {Object} Mrf~ConnectOptions
 * @property {String} address - hostname or IP address to connect to
 * @property {Number} [port=8021] - TCP port to connect to
 * @property {String} [secret=ClueCon] - freeswitch authentication secret
 * @property {Number} [listenPort=8085] -  local TCP port to listen for external connections from the freeswitch media server
 */

 /**
 * Error event triggered when connection to freeswitch media server fails.
 *
 * @event Mrf#error
 * @type {object}
 * @property {String} message - Indicates the reason the connection failed
 */
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Nov 23 2015 21:19:17 GMT-0500 (EST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
