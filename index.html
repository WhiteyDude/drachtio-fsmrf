<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Drachtio-fsmrf by davehorton</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">drachtio-fsmrf</h1>
      <h2 class="project-tagline">drachtio media resource function</h2>
      <a href="https://github.com/davehorton/drachtio-fsmrf" class="btn">View on GitHub</a>
      <a href="https://github.com/davehorton/drachtio-fsmrf/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/davehorton/drachtio-fsmrf/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <div class="drachtio-img"><img src="http://davehorton.github.io/drachtio-fsmrf/img/definition-only-cropped.png">
      </div>
      <p>
        Welcome to the drachtio media resource function, empowering nodejs/javascript developers to build rich media application on SIP / VoIP networks
      </p>
      <p>drachtio is an open-source, nodejs-based ecosystem for creating any kind of VoIP server-based application: registrar, proxy, back-to-back user agent, and many others. Within the drachtio ecosystem, drachtio-fsmrf is a high-level media processing abstraction layer  that utilizes freeswitch as a media server, and partners with the <a href="http://davehorton.github.io/drachtio-srf/">drachtio signaling resource framework</a> to enable the creation of media-processing applications such as conferencing, IVR and others.
      </p>

      <p><strong>Note:</strong> API documentation for drachtio-fsmrf <a href="http://davehorton.github.io/drachtio-fsmrf/api/index.html">can be found here</a>.

      <pre>
var app = require('drachtio')() ;
var Mrf = require('drachtio-fsmrf') ;
var mrf = new Mrf(app) ;
var Srf = require('drachtio-srf') ;
var srf = new Srf(app) ;
var ms  ;

srf.connect({...}) ;
mrf.connect({...}, function(mediaServer) {ms = mediaServer;}) ;

srf.invite( function(req, res) {
  
  // connect caller to an endpoint on the media server
  ms.connectCaller(req, res, function(err, ep, dialog) {
    if( err ) thrown err ;

    // set up dialog handlers
    dialog.on('destroy', onCallerHangup.bind(dialog, ep)) ;

    // play some prompts
    ep.play(['ivr/8000/ivr-please_reenter_your_pin.wav',
      'ivr/8000/ivr-please_state_your_name_and_reason_for_calling.wav',
      'ivr/8000/ivr-you_lose.wav'], function(err, results){
        console.log('results: ', results) ;
      }) ;
  }) ; 
}) ;

function onCallerHangup( ep ) {
  // release endpoint
  ep.destroy() ;
}</pre>

      <h3>Getting Started</h3>
      <p><strong>Note:</strong> drachtio-fsmrf applications require a network connection to a <a href="https://github.com/davehorton/drachtio-server">drachtio server</a> process that sits in the VoIP network and handles the low-level SIP messaging.
      </p>
      <p><strong>Additionally</strong>, drachtio-fsmrf applications require a freeswitch media server, configured as defined in the <a href="https://github.com/davehorton/drachtio-fs-ansible">drachtio-fs-ansible</a>, which provides an ansible role that can be used build up a freeswitch media server for use with drachtio-fsrmf from a vanilla ubuntu install.
      </p>
      <h4>Install drachtio-fsmrf</h4>
      <p>
        <pre>
npm install drachtio-fsmrf --save</pre>
      </p>
      <h4>Create an instance of the media resource function</h4>
        <p>First, create a drachtio "app".  This contains the middleware stack and core message routing functions needed for the core drachtio library that is central to all drachtio applications.  Next, create a new instance of the drachtio media resource function, passing the drachtio app that you just created.
          <pre>
var drachtio = require('drachtio') ;
var app = drachtio();
var Mrf = require('drachtio-fsmrf'); 
var mrf = new Mrf(app) ;</pre>
        </p>
      <h4>Create an instance of the signaling resource framework</h4>
        <p>In most cases, you will also want to create an instance of the <a href="http://davehorton.github.io/drachtio-srf/">drachtio signaling resource framework</a> as well, in order to handle the SIP signaling requirements of the application.
          <pre>
var Srf = require('drachtio-srf'); 
var srf = new Srf(app) ;</pre>
        </p>
    <h4>Connect to one or more freeswitch media servers</h4>
    <p>In order to create and manipulate <a href="http://davehorton.github.io/drachtio-fsmrf/api/Endpoint.html">endpoints</a>, <a href="http://davehorton.github.io/drachtio-fsmrf/api/Conference.html">conferences</a> and other resources, you must first obtain a reference to an instance of a <a href="http://davehorton.github.io/drachtio-fsmrf/api/MediaServer.html">MediaServer</a>.  This is done by the 'mrf.connect' method:
    </p>
    <pre>
mrf.connect({
  address: 10.1.0.100,  // IP address freeswitch event socket is listening on
  port: 8021,           // freeswitch event socket listen port
  secret: 'ClueCon',    // freeswitch authentication secret
  listenPort: 8085      // leave at 8085; unless freeswitch dial plan is changed
}, function(ms) {
  console.log('connected to mediaserver: ', JSON.stringify(ms)) ;
});</pre>
  <h4>Allocate and manipulate resources on a media server</h4>
  <p>Once you have obtained a reference to a media server, you can obtain access to resources on the media server via any of the following methods:
    <ul>
      <li><a href="http://davehorton.github.io/drachtio-fsmrf/api/MediaServer.html#createConference">MediaServer#createConference</a></li>
      <li><a href="http://davehorton.github.io/drachtio-fsmrf/api/MediaServer.html#createEndpoint">MediaServer#createEndpoint</a></li>
      <li><a href="http://davehorton.github.io/drachtio-fsmrf/api/MediaServer.html#connectCaller">MediaServer#connectCaller</a></li>
    </ul>
    You can also send freeswitch api commands directly to the media server by invoking the <a href="http://davehorton.github.io/drachtio-fsmrf/api/MediaServer.html#api">MediaServer#api</a> method.
  </p>

  <h3>IVR Features</h3>
  <p>
  Once you have an <a href="http://davehorton.github.io/drachtio-fsmrf/api/Endpoint.html">endpoint</a>, and a connected SIP <a href="http://davehorton.github.io/drachtio-srf/api/Dialog.html">dialog</a>, you can create IVR interactions by calling methods on the endpoint:
  <ul>
    <li><a href="http://davehorton.github.io/drachtio-fsmrf/api/Endpoint.html#play">Endpoint#play</a> - play one or more audio files</li>
    <li><a href="http://davehorton.github.io/drachtio-fsmrf/api/Endpoint.html#playCollect">Endpoint#playCollect</a> - play an audio file and collect DTMF input from the call</li>
    <li><a href="http://davehorton.github.io/drachtio-fsmrf/api/Endpoint.html#say">Endpoint#say</a> - speak a phrase, using a defined grammar</li>
  </ul>
  </p>

  <h3>Conferencing Features</h3>
  <p>There are two ways to create a conference:
    <ol>
      <li>By calling <a href="http://davehorton.github.io/drachtio-fsmrf/api/MediaServer.html#createConference">MediaServer#createConference</a> which creates a named conference on the media server</li>
      <li>By allocating an endpoint, and then calling <a href="http://davehorton.github.io/drachtio-fsmrf/api/Endpoint.html#joinConference">Endpoint#joinConference</a>, to which you can either pass a previously allocated conference object, or simply the name of a conference.  In the latter case, a conference is dynamically created on the media server.</li>
    </ol>
  </p>

    <h3>Sample applications</h3>
    <p>Besides the example applications found in the <a href="">examples</a> folder, the following full-fledged sample applications are available:
      <ul>
        <li><a href="https://github.com/davehorton/drachtio-sample-twostage-dialing">Two-stage dialing application</a></li>
      </ul>
    </p>

    <h3>License</h3>
      <a href="https://github.com/davehorton/drachtio-fsmrf/blob/master/LICENSE">MIT</a>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/davehorton/drachtio-fsmrf">drachtio-fsmrf</a> is maintained by <a href="https://github.com/davehorton">davehorton</a>.</span>
      </footer>

    </section>

  </body>
</html>
